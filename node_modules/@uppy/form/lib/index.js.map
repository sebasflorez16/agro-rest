{"version":3,"names":["BasePlugin","findDOMElement","toArray","getFormData","packageJson","defaultOptions","resultName","getMetaFromForm","addResultToForm","submitOnSuccess","triggerUploadOnSubmit","assertHTMLFormElement","input","nodeName","Error","cause","Form","constructor","uppy","opts","type","id","handleFormSubmit","bind","handleUploadStart","handleSuccess","result","form","reportValidity","submit","ev","preventDefault","elements","target","disabledByUppy","forEach","el","isButton","tagName","disabled","push","upload","then","button","err","Promise","reject","catch","log","stack","message","resultInput","querySelector","updatedResult","JSON","parse","value","Array","isArray","stringify","document","createElement","name","appendChild","formMeta","setMeta","install","addEventListener","on","uninstall","removeEventListener","off","VERSION","version"],"sources":["index.ts"],"sourcesContent":["import BasePlugin, { type DefinePluginOpts } from '@uppy/core/lib/BasePlugin.js'\nimport findDOMElement from '@uppy/utils/lib/findDOMElement'\nimport toArray from '@uppy/utils/lib/toArray'\n\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore untyped\nimport getFormData from 'get-form-data'\n\nimport type { UIPluginOptions, Uppy, UppyEventMap } from '@uppy/core'\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\n\ntype Result<M extends Meta, B extends Body> = Parameters<\n  UppyEventMap<M, B>['complete']\n>[0]\n\nexport interface FormOptions extends UIPluginOptions {\n  resultName?: string\n  getMetaFromForm?: boolean\n  addResultToForm?: boolean\n  submitOnSuccess?: boolean\n  triggerUploadOnSubmit?: boolean\n}\n\nconst defaultOptions = {\n  resultName: 'uppyResult',\n  getMetaFromForm: true,\n  addResultToForm: true,\n  submitOnSuccess: false,\n  triggerUploadOnSubmit: false,\n}\n\ntype Opts = DefinePluginOpts<FormOptions, keyof typeof defaultOptions>\n\nfunction assertHTMLFormElement(input: Node | null): HTMLFormElement {\n  if (input == null || input.nodeName !== 'FORM') {\n    throw new Error('ASSERTION FAILED: the target is not a <form> element', {\n      cause: input,\n    })\n  }\n  return input as any\n}\n\nexport default class Form<M extends Meta, B extends Body> extends BasePlugin<\n  Opts,\n  M,\n  B\n> {\n  static VERSION = packageJson.version\n\n  form: HTMLFormElement // TODO: make this private (or at least, mark it as readonly)\n\n  constructor(uppy: Uppy<M, B>, opts?: FormOptions) {\n    super(uppy, { ...defaultOptions, ...opts })\n    this.type = 'acquirer'\n    this.id = this.opts.id || 'Form'\n\n    this.handleFormSubmit = this.handleFormSubmit.bind(this)\n    this.handleUploadStart = this.handleUploadStart.bind(this)\n    this.handleSuccess = this.handleSuccess.bind(this)\n    this.addResultToForm = this.addResultToForm.bind(this)\n    this.getMetaFromForm = this.getMetaFromForm.bind(this)\n  }\n\n  handleUploadStart(): void {\n    if (this.opts.getMetaFromForm) {\n      this.getMetaFromForm()\n    }\n  }\n\n  handleSuccess(result: Result<M, B>): void {\n    if (this.opts.addResultToForm) {\n      this.addResultToForm(result)\n    }\n\n    if (this.opts.submitOnSuccess) {\n      // Returns true if the element's child controls satisfy their validation constraints.\n      // When false is returned, cancelable invalid events are fired for each invalid child\n      // and validation problems are reported to the user.\n      if (this.form.reportValidity()) {\n        this.form.submit()\n      }\n    }\n  }\n\n  handleFormSubmit(ev: Event): void {\n    if (this.opts.triggerUploadOnSubmit) {\n      ev.preventDefault()\n      const elements = toArray((ev.target as HTMLFormElement).elements)\n      const disabledByUppy: HTMLButtonElement[] = []\n      elements.forEach((el) => {\n        const isButton =\n          el.tagName === 'BUTTON' ||\n          (el.tagName === 'INPUT' &&\n            (el as HTMLButtonElement).type === 'submit')\n        if (isButton && !(el as HTMLButtonElement).disabled) {\n          ;(el as HTMLButtonElement).disabled = true // eslint-disable-line no-param-reassign\n          disabledByUppy.push(el as HTMLButtonElement)\n        }\n      })\n      this.uppy\n        .upload()\n        .then(\n          () => {\n            disabledByUppy.forEach((button) => {\n              button.disabled = false // eslint-disable-line no-param-reassign\n            })\n          },\n          (err) => {\n            disabledByUppy.forEach((button) => {\n              button.disabled = false // eslint-disable-line no-param-reassign\n            })\n            return Promise.reject(err)\n          },\n        )\n        .catch((err) => {\n          this.uppy.log(err.stack || err.message || err)\n        })\n    }\n  }\n\n  addResultToForm(result: Result<M, B>): void {\n    this.uppy.log('[Form] Adding result to the original form:')\n    this.uppy.log(result)\n\n    let resultInput: HTMLInputElement | null = this.form.querySelector(\n      `[name=\"${this.opts.resultName}\"]`,\n    )\n    if (resultInput) {\n      // Append new result to the previous result array.\n      // If the previous result is empty, or not an array,\n      // set it to an empty array.\n      let updatedResult\n      try {\n        updatedResult = JSON.parse(resultInput.value)\n      } catch (err) {\n        // Nothing, since we check for array below anyway\n      }\n\n      if (!Array.isArray(updatedResult)) {\n        updatedResult = []\n      }\n      updatedResult.push(result)\n      resultInput.value = JSON.stringify(updatedResult)\n      return\n    }\n\n    resultInput = document.createElement('input')\n    resultInput.name = this.opts.resultName\n    resultInput.type = 'hidden'\n    resultInput.value = JSON.stringify([result])\n\n    this.form.appendChild(resultInput)\n  }\n\n  getMetaFromForm(): void {\n    const formMeta = getFormData(this.form)\n    // We want to exclude meta the the Form plugin itself has added\n    // See https://github.com/transloadit/uppy/issues/1637\n    delete formMeta[this.opts.resultName]\n    this.uppy.setMeta(formMeta)\n  }\n\n  install(): void {\n    this.form = assertHTMLFormElement(findDOMElement(this.opts.target))\n\n    this.form.addEventListener('submit', this.handleFormSubmit)\n    this.uppy.on('upload', this.handleUploadStart)\n    this.uppy.on('complete', this.handleSuccess)\n  }\n\n  uninstall(): void {\n    this.form.removeEventListener('submit', this.handleFormSubmit)\n    this.uppy.off('upload', this.handleUploadStart)\n    this.uppy.off('complete', this.handleSuccess)\n  }\n}\n"],"mappings":"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"}